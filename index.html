<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Food List & Meal Builder</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
body { font-family: Arial, sans-serif; margin: 10px; color:#111; background:#fff; max-width:1200px; }
h1,h2{ margin:0 0 8px 0; }
.grid{ display:grid; grid-template-columns:1fr 1fr; gap:20px; }
.box{ border:1px solid #ddd; padding:12px; border-radius:10px; background:#f9f9f9; }
.flex{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
.column{ display:flex; flex-direction:column; gap:8px; }
input[type=text], input[type=number], input[type=search]{ padding:6px 8px; border-radius:6px; border:1px solid #ccc; width:100%; box-sizing:border-box; }
.btn{ padding:6px 10px; border:none; border-radius:6px; cursor:pointer; transition:0.1s; }
.btn-primary{ background:#2563eb; color:#fff; }
.btn-secondary{ background:#eee; color:#111; }
.btn-danger{ background:#ef4444; color:#fff; }
.btn-sm{ padding:4px 6px; font-size:0.85rem; }
table{ width:100%; border-collapse:collapse; margin-top:8px; }
th,td{ border-bottom:1px solid #eee; padding:6px 8px; text-align:left; }
th{ font-weight:600; }
.meal-grams{ width:60px; text-align:center; }
.muted{ color:#666; font-size:0.9rem; }
@media (max-width:800px){ .grid{ grid-template-columns:1fr; } }
</style>
</head>
<body>
<h1>Food List & Meal Builder</h1>
<div class="grid">

<div>
  <div class="box">
    <h2>Add Foods</h2>
    <div class="flex">
      <label>Name<br><input id="foodName" type="text" placeholder="Food name" /></label>
      <label>Serving (g)<br><input id="servingGrams" type="number" inputmode="numeric" /></label>
      <label>Carbs (g)<br><input id="carbs" type="number" inputmode="numeric" /></label>
      <label>Protein (g)<br><input id="protein" type="number" inputmode="numeric" /></label>
      <div style="align-self:flex-end;"><button id="addFoodBtn" class="btn btn-primary">Add Food</button></div>
    </div>
  </div>

  <div class="box">
    <h2>Saved Foods</h2>
    <div class="flex">
      <input id="searchFood" type="search" placeholder="Search foods..." />
      <button id="clearAllFoods" class="btn btn-danger btn-sm">Clear All</button>
    </div>
    <table id="foodsTable">
      <thead><tr><th>Name</th><th>Serving (g)</th><th>Carbs (g)</th><th>Protein (g)</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div>
  <div class="box">
    <h2>Meal Builder</h2>
    <table id="mealTable">
      <thead>
        <tr><th>Food</th><th>Serving (g)</th><th>Consumed (g)</th><th>Carbs (g)</th><th>Protein (g)</th><th>Actions</th></tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <td><strong>Totals</strong></td><td></td><td></td><td id="totalCarbs">0</td><td id="totalProtein">0</td><td></td>
        </tr>
      </tfoot>
    </table>
    <div class="flex" style="margin-top:10px; justify-content:space-between;">
      <button id="clearMeal" class="btn btn-secondary">Clear Meal</button>
      <button id="saveMealBtn" class="btn btn-primary">Save Meal</button>
    </div>
  </div>

  <div class="box">
    <h2 style="display:inline-block;">Saved Meals</h2>
    <button id="exportCsvBtn" class="btn btn-primary btn-sm" style="margin-left:8px;">Export CSV</button>
    <table id="savedMealsTable">
      <thead>
        <tr><th>Date</th><th>Time</th><th>Foods</th><th>Total Carbs (g)</th><th>Total Protein (g)</th><th>Actions</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

</div>

<script>
// Storage and data
const STORAGE_FOODS='foods', STORAGE_MEALS='meals';
let foods=JSON.parse(localStorage.getItem(STORAGE_FOODS)||'[]');
let meal=[], savedMeals=JSON.parse(localStorage.getItem(STORAGE_MEALS)||'[]');

function saveStorage(key,val){ localStorage.setItem(key,JSON.stringify(val)); }

function renderFoods(filter=''){
  const tbody=document.querySelector('#foodsTable tbody'); tbody.innerHTML='';
  const q=filter.trim().toLowerCase();
  foods.forEach(f=>{
    if(q && !f.name.toLowerCase().includes(q)) return;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${f.name}</td><td>${f.servingGrams}</td><td>${f.carbs}</td><td>${f.protein}</td>
      <td>
        <button class="btn btn-primary btn-sm add-to-meal" data-id="${f.id}">Add</button>
        <button class="btn btn-danger btn-sm delete-food" data-id="${f.id}">Delete</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

function computeNutrients(s,c,p,consumed){ const ratio=consumed/s||0; return {carbs:c*ratio, protein:p*ratio}; }

function renderMeal(){
  const tbody=document.querySelector('#mealTable tbody'); tbody.innerHTML='';
  let totalC=0, totalP=0;
  meal.forEach((f,idx)=>{
    const nut=computeNutrients(f.servingGrams,f.carbs,f.protein,f.consumedGrams||f.servingGrams);
    totalC+=nut.carbs; totalP+=nut.protein;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${f.name}</td><td>${f.servingGrams}</td>
      <td><input class="meal-grams" data-idx="${idx}" type="number" inputmode="numeric" value="${f.consumedGrams||f.servingGrams}" /></td>
      <td>${nut.carbs.toFixed(2)}</td><td>${nut.protein.toFixed(2)}</td>
      <td><button data-idx="${idx}" class="btn btn-secondary btn-sm remove-from-meal">Remove</button></td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('totalCarbs').textContent=totalC.toFixed(2);
  document.getElementById('totalProtein').textContent=totalP.toFixed(2);
}

function renderSavedMeals(){
  const tbody=document.querySelector('#savedMealsTable tbody'); tbody.innerHTML='';
  savedMeals.forEach((m,idx)=>{
    const foodsStr=m.foods.map(f=>`${f.name}(${f.consumedGrams}g)`).join(', ');
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${m.date}</td><td>${m.time}</td><td>${foodsStr}</td><td>${m.totalCarbs.toFixed(2)}</td><td>${m.totalProtein.toFixed(2)}</td>
      <td><button data-idx="${idx}" class="btn btn-danger btn-sm delete-meal">Delete</button></td>`;
    tbody.appendChild(tr);
  });
}

// Add food
document.getElementById('addFoodBtn').onclick=function(){
  const name=document.getElementById('foodName').value.trim();
  const s=Number(document.getElementById('servingGrams').value);
  const c=Number(document.getElementById('carbs').value);
  const p=Number(document.getElementById('protein').value);
  if(!name||isNaN(s)||isNaN(c)||isNaN(p)){ alert('Enter valid values'); return; }
  const id=Date.now().toString(36)+Math.random().toString(36).slice(2,6);
  foods.push({id,name,servingGrams:s,carbs:c,protein:p});
  saveStorage(STORAGE_FOODS,foods);
  renderFoods();
  document.getElementById('foodName').value=''; document.getElementById('servingGrams').value=''; document.getElementById('carbs').value=''; document.getElementById('protein').value='';
};

document.getElementById('searchFood').oninput=function(){ renderFoods(this.value); };
document.getElementById('clearAllFoods').onclick=function(){ if(confirm('Delete all foods?')){ foods=[]; saveStorage(STORAGE_FOODS,foods); renderFoods(); } };

// Meal table events
document.addEventListener('click',function(e){
  if(e.target.matches('.add-to-meal')){ const f=foods.find(x=>x.id===e.target.dataset.id); if(f){ meal.push({...f,consumedGrams:f.servingGrams}); renderMeal(); } }
  if(e.target.matches('.remove-from-meal')){ meal.splice(Number(e.target.dataset.idx),1); renderMeal(); }
  if(e.target.matches('.delete-food')){ if(confirm('Delete this food?')){ foods=foods.filter(x=>x.id!==e.target.dataset.id); saveStorage(STORAGE_FOODS,foods); renderFoods(); } }
  if(e.target.matches('.delete-meal')){ savedMeals.splice(Number(e.target.dataset.idx),1); saveStorage(STORAGE_MEALS,savedMeals); renderSavedMeals(); }
});

// Update consumed
document.addEventListener('focusin',function(e){ if(e.target.matches('.meal-grams')) e.target.value=''; });
document.addEventListener('input',function(e){ if(!e.target.matches('.meal-grams')) return;
  const idx=Number(e.target.dataset.idx); if(!meal[idx]) return;
  meal[idx].consumedGrams=Number(e.target.value)||0; renderMeal();
});

// Clear meal
document.getElementById('clearMeal').onclick=function(){ if(confirm('Clear current meal?')){ meal=[]; renderMeal(); } };

// Save meal
document.getElementById('saveMealBtn').onclick=function(){
  if(meal.length===0){ alert('No foods in meal'); return; }
  const now=new Date(); const date=now.toLocaleDateString(); const time=now.toLocaleTimeString();
  const totalCarbs=meal.reduce((sum,f)=>sum+computeNutrients(f.servingGrams,f.carbs,f.protein,f.consumedGrams).carbs,0);
  const totalProtein=meal.reduce((sum,f)=>sum+computeNutrients(f.servingGrams,f.carbs,f.protein,f.consumedGrams).protein,0);
  savedMeals.push({date,time,foods:JSON.parse(JSON.stringify(meal)),totalCarbs,totalProtein});
  saveStorage(STORAGE_MEALS,savedMeals);
  renderSavedMeals();
  meal=[]; renderMeal();
};

// Export CSV
document.getElementById('exportCsvBtn').onclick=function(){
  if(savedMeals.length===0){ alert('No saved meals'); return; }
  const header=['Date','Time','Foods','Total Carbs (g)','Total Protein (g)'];
  const rows=savedMeals.map(m=>[m.date,m.time,`"${m.foods.map(f=>f.name+'('+f.consumedGrams+'g)').join(', ')}"`,m.totalCarbs.toFixed(2),m.totalProtein.toFixed(2)]);
  const csv=[header,...rows].map(r=>r.join(',')).join('\r\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=`saved_meals_${new Date().toISOString().slice(0,10)}.csv`; a.click(); URL.revokeObjectURL(url);
};

// Initial render
renderFoods(); renderMeal(); renderSavedMeals();
</script>
</body>
</html>
