<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Food List & Meal Builder</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
body { font-family: Arial, sans-serif; margin: 10px; color:#111; background:#fff; max-width:1200px; }
h1,h2{ margin:0 0 8px 0; }
.grid{ display:grid; grid-template-columns:1fr 1fr; gap:20px; }
.box{ border:1px solid #ddd; padding:12px; border-radius:10px; background:#f9f9f9; }
.flex{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
.column{ display:flex; flex-direction:column; gap:8px; }
input[type=text], input[type=number], input[type=search]{ padding:6px 8px; border-radius:6px; border:1px solid #ccc; width:100%; box-sizing:border-box; }
.btn{ padding:6px 10px; border:none; border-radius:6px; cursor:pointer; transition:0.1s; }
.btn-primary{ background:#2563eb; color:#fff; }
.btn-secondary{ background:#eee; color:#111; }
.btn-danger{ background:#ef4444; color:#fff; }
.btn-sm{ padding:4px 6px; font-size:0.85rem; }
table{ width:100%; border-collapse:collapse; margin-top:8px; }
th,td{ border-bottom:1px solid #eee; padding:6px 8px; text-align:left; }
th{ font-weight:600; }
.meal-grams{ width:60px; text-align:center; }
.muted{ color:#666; font-size:0.9rem; }
@media (max-width:800px){ .grid{ grid-template-columns:1fr; } }
</style>
</head>
<body>

<h1>Food List & Meal Builder</h1>

<div class="grid">

<div>
  <div class="box">
    <h2>Add Foods</h2>
    <div class="flex">
      <label>Name<br><input id="foodName" type="text" /></label>
      <label>Serving (g)<br><input id="servingGrams" type="number" inputmode="numeric" /></label>
      <label>Carbs (g)<br><input id="carbs" type="number" inputmode="numeric" /></label>
      <label>Protein (g)<br><input id="protein" type="number" inputmode="numeric" /></label>
      <div style="align-self:flex-end;">
        <button id="addFoodBtn" class="btn btn-primary">Add Food</button>
      </div>
    </div>
  </div>

  <div class="box">
    <h2>Saved Foods</h2>
    <div class="flex">
      <input id="searchFood" type="search" placeholder="Search foods..." />
      <button id="clearAllFoods" class="btn btn-danger btn-sm">Clear All</button>
    </div>
    <table id="foodsTable">
      <thead>
        <tr><th>Name</th><th>Serving (g)</th><th>Carbs</th><th>Protein</th><th></th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div>
  <div class="box">
    <h2>Meal Builder</h2>
    <table id="mealTable">
      <thead>
        <tr>
          <th>Food</th>
          <th>Serving (g)</th>
          <th>Consumed (g)</th>
          <th>Carbs</th>
          <th>Protein</th>
          <th></th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <td><strong>Totals</strong></td>
          <td></td>
          <td></td>
          <td id="totalCarbs">0</td>
          <td id="totalProtein">0</td>
          <td></td>
        </tr>
      </tfoot>
    </table>
    <div class="flex" style="margin-top:10px; justify-content:space-between;">
      <button id="clearMeal" class="btn btn-secondary">Clear Meal</button>
      <button id="saveMealBtn" class="btn btn-primary">Save Meal</button>
    </div>
  </div>

  <div class="box">
    <h2>Saved Meals</h2>
    <button id="exportCsvBtn" class="btn btn-primary btn-sm">Export CSV</button>
    <table id="savedMealsTable">
      <thead>
        <tr><th>Date</th><th>Time</th><th>Foods</th><th>Carbs</th><th>Protein</th><th></th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

</div>

<script>
const STORAGE_FOODS='foods', STORAGE_MEALS='meals';
let foods=JSON.parse(localStorage.getItem(STORAGE_FOODS)||'[]');
let meal=[], savedMeals=JSON.parse(localStorage.getItem(STORAGE_MEALS)||'[]');

const saveStorage=(k,v)=>localStorage.setItem(k,JSON.stringify(v));

const computeNutrients=(s,c,p,g)=>{
  const r=(g||0)/s||0;
  return { carbs:c*r, protein:p*r };
};

function renderFoods(filter=''){
  const tbody=document.querySelector('#foodsTable tbody');
  tbody.innerHTML='';
  foods.filter(f=>!filter||f.name.toLowerCase().includes(filter.toLowerCase()))
    .forEach(f=>{
      tbody.insertAdjacentHTML('beforeend',`
        <tr>
          <td>${f.name}</td>
          <td>${f.servingGrams}</td>
          <td>${f.carbs}</td>
          <td>${f.protein}</td>
          <td>
            <button class="btn btn-primary btn-sm add-to-meal" data-id="${f.id}">Add</button>
            <button class="btn btn-danger btn-sm delete-food" data-id="${f.id}">Del</button>
          </td>
        </tr>
      `);
    });
}

function renderMeal(){
  const tbody=document.querySelector('#mealTable tbody');
  tbody.innerHTML='';
  meal.forEach((f,i)=>{
    const n=computeNutrients(f.servingGrams,f.carbs,f.protein,f.consumedGrams);
    tbody.insertAdjacentHTML('beforeend',`
      <tr>
        <td>${f.name}</td>
        <td>${f.servingGrams}</td>
        <td>
          <input class="meal-grams" type="number" inputmode="numeric"
            data-idx="${i}" value="${f.consumedGrams}">
        </td>
        <td>${n.carbs.toFixed(2)}</td>
        <td>${n.protein.toFixed(2)}</td>
        <td>
          <button class="btn btn-secondary btn-sm remove-from-meal" data-idx="${i}">Remove</button>
        </td>
      </tr>
    `);
  });
  updateTotals();
}

function updateTotals(){
  let c=0,p=0;
  meal.forEach(f=>{
    const n=computeNutrients(f.servingGrams,f.carbs,f.protein,f.consumedGrams);
    c+=n.carbs; p+=n.protein;
  });
  totalCarbs.textContent=c.toFixed(2);
  totalProtein.textContent=p.toFixed(2);
}

document.addEventListener('input',e=>{
  if(!e.target.matches('.meal-grams')) return;
  const i=+e.target.dataset.idx;
  meal[i].consumedGrams=Number(e.target.value)||0;
  updateTotals(); // âœ… no re-render
});

document.addEventListener('blur',e=>{
  if(e.target.matches('.meal-grams')) renderMeal();
},true);

document.addEventListener('click',e=>{
  if(e.target.matches('.add-to-meal')){
    const f=foods.find(x=>x.id===e.target.dataset.id);
    meal.push({...f,consumedGrams:f.servingGrams});
    renderMeal();
  }
  if(e.target.matches('.remove-from-meal')){
    meal.splice(+e.target.dataset.idx,1);
    renderMeal();
  }
});

document.getElementById('addFoodBtn').onclick=()=>{
  const name=foodName.value.trim();
  const s=+servingGrams.value,c=+carbs.value,p=+protein.value;
  if(!name||!s||!c||!p) return alert('Enter valid values');
  foods.push({id:crypto.randomUUID(),name,servingGrams:s,carbs:c,protein:p});
  saveStorage(STORAGE_FOODS,foods);
  renderFoods();
  foodName.value=servingGrams.value=carbs.value=protein.value='';
};

searchFood.oninput=e=>renderFoods(e.target.value);

renderFoods(); renderMeal();
</script>
</body>
</html>
