<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Food List & Meal Builder — Wide Meal Builder</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#ffffff; --muted:#6b7280; --border:#e6e9ee; --card:#f9fafb;
      --accent:#2563eb; --accent-600:#1e40af; --danger:#ef4444;
      --shadow:0 6px 18px rgba(32,33,36,0.06);
    }
    html,body{height:100%}
    body {
      font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif;
      margin: 20px;
      color:#111827;
      background:var(--bg);
      max-width:1600px;
    }

    /* Two-column grid — make the meal builder (right) column very wide */
    .grid {
      display:grid;
      grid-template-columns: 1fr 720px; /* increase right column width here (was 520/420 before) */
      gap:20px;
      align-items:start;
    }

    .col-left { display:flex; flex-direction:column; gap:20px; }
    .col-right { display:flex; flex-direction:column; gap:20px; }

    .box{
      border:1px solid var(--border);
      padding:14px;
      border-radius:12px;
      background:var(--card);
      box-shadow:var(--shadow);
      overflow: visible;
    }

    h1{margin:0 0 14px 0}
    h2{margin:0 0 8px 0}

    .flex { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .column { display:flex; flex-direction:column; gap:8px; }
    .right { margin-left:auto; display:flex; gap:8px; align-items:center; }

    input[type="number"], input[type="text"], input[type="search"] {
      padding:8px 10px; border:1px solid var(--border); border-radius:8px; outline:none;
      min-width:100px; transition:box-shadow .12s, border-color .12s;
    }
    input:focus { border-color:var(--accent); box-shadow:0 4px 10px rgba(37,99,235,0.08); }

    table{ width:100%; border-collapse:collapse; margin-top:8px; }
    th,td{ padding:8px 10px; border-bottom:1px solid #f1f5f9; text-align:left; vertical-align:middle; }
    th{ font-weight:600; color:#374151; font-size:0.95rem; }

    /* Buttons */
    .btn{ display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:10px;
      border:1px solid transparent; font-weight:600; cursor:pointer; transition:transform .06s, box-shadow .12s;
      box-shadow:0 2px 8px rgba(16,24,40,0.04); background:linear-gradient(180deg, rgba(255,255,255,0.4), rgba(255,255,255,0)); }
    .btn:active{ transform:translateY(1px) }
    .btn-primary{ color:#fff; background:linear-gradient(180deg,var(--accent),var(--accent-600));
      box-shadow:0 8px 20px rgba(37,99,235,0.18) }
    .btn-secondary{ color:#0f172a; background:linear-gradient(180deg,#fff,#f5f7fb); border:1px solid #d1d5db }
    .btn-danger{ color:#fff; background:linear-gradient(180deg,var(--danger),#b91c1c) }
    .btn-sm{ padding:6px 8px; border-radius:8px; font-size:0.85rem }

    .controls{ display:flex; gap:8px; align-items:center; width:100% }
    .controls input[type="search"]{ flex:1; min-width:160px }

    .muted{ color:var(--muted); font-size:0.92rem }

    @media (max-width:1100px){
      /* For narrower screens, collapse to single column */
      .grid{ grid-template-columns: 1fr; }
      .col-right { order: 99; }
    }

    /* -- Make consumed input look like a plain integer input (remove spinners) -- */
    .meal-grams::-webkit-outer-spin-button,
    .meal-grams::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    .meal-grams {
      -moz-appearance: textfield; /* Firefox */
      width: 84px;
      padding: 6px;
      border-radius: 8px;
      border: 1px solid #e6e9ee;
      text-align: center;
      font-size: 0.95rem;
    }

    /* Table wrapper: allow horizontal scrolling if required */
    .table-wrap {
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* Make meal table columns expand as needed: use auto layout so columns take available space */
    #mealTable {
      width: 100%;
      border-collapse: collapse;
      table-layout: auto; /* let columns size naturally and expand */
    }

    /* Ensure header text uses full phrases (prevent truncation) */
    #mealTable thead th { white-space: normal; line-height:1.2; }

    /* Make the first column (Name) take as much space as possible */
    #mealTable th:nth-child(1),
    #mealTable td:nth-child(1) {
      width: 50%; /* allocate half of table width to name column where possible */
      min-width: 240px;
      white-space: normal;
      word-break: break-word;
    }

    /* Right-align numeric columns for readability */
    #mealTable th:nth-child(n+2),
    #mealTable td:nth-child(n+2) {
      text-align: right;
      white-space: nowrap;
    }

    /* Keep numeric columns reasonably sized */
    #mealTable th:nth-child(2), #mealTable td:nth-child(2),
    #mealTable th:nth-child(3), #mealTable td:nth-child(3),
    #mealTable th:nth-child(4), #mealTable td:nth-child(4),
    #mealTable th:nth-child(5), #mealTable td:nth-child(5) {
      max-width: 160px;
    }

    @media (max-width:640px){
      #mealTable { table-layout: auto; }
      #mealTable th:nth-child(1),
      #mealTable td:nth-child(1) { width: auto; min-width: auto; }
      #mealTable th:nth-child(n+2),
      #mealTable td:nth-child(n+2) { text-align: left; white-space: normal; }
      .meal-grams { width: 64px; }
    }
  </style>
</head>
<body>
  <h1>Food List & Meal Builder</h1>

  <div class="grid">
    <div class="col-left">
      <div class="box">
        <h2>Add a Food</h2>
        <div class="flex">
          <label>
            Name<br>
            <input id="foodName" type="text" placeholder="e.g., Chicken breast" />
          </label>
          <label>
            Serving (g)<br>
            <input id="servingGrams" type="number" min="0" step="any" />
          </label>
          <label>
            Carbs (g)<br>
            <input id="carbs" type="number" min="0" step="any" />
          </label>
          <label>
            Protein (g)<br>
            <input id="protein" type="number" min="0" step="any" />
          </label>
          <div>
            <br>
            <button id="addFoodBtn" class="btn btn-primary" title="Save this food">
              <svg class="icon" width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden>
                <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              Add Food
            </button>
          </div>
        </div>
        <p class="muted" style="margin-top:8px;">Tip: You can add multiple foods and they are saved in your browser.</p>
      </div>

      <div class="box">
        <h2>Saved Foods</h2>
        <div class="controls">
          <input id="searchFood" type="search" placeholder="Search foods..." />
          <button id="clearAllFoods" class="btn btn-danger btn-sm" title="Remove all saved foods">Clear All Foods</button>
          <div class="right">
            <button id="exportFoods" class="btn btn-secondary btn-sm" title="Download foods as JSON">Export Foods (.json)</button>
            <input id="importFile" type="file" accept="application/json" style="display:none" />
            <button id="importFoods" class="btn btn-secondary btn-sm" title="Import foods from JSON">Import Foods (.json)</button>
          </div>
        </div>

        <table id="foodsTable">
          <thead><tr><th>Name</th><th>Serving (g)</th><th>Carbs (g)</th><th>Protein (g)</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="col-right">
      <div class="box">
        <h2>Meal Builder</h2>
        <p class="muted">For each item, enter how many grams you ate — carbs and protein will be calculated from the saved serving size.</p>

        <div class="table-wrap">
          <table id="mealTable">
            <thead>
              <tr>
                <th>Food Name</th>
                <th>Serving Size (g)</th>
                <th>Consumed (g)</th>
                <th>Carbohydrates (g)</th>
                <th>Protein (g)</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr>
                <td><strong>Totals</strong></td>
                <td></td>
                <td></td>
                <td id="totalCarbs">0</td>
                <td id="totalProtein">0</td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>

        <div style="margin-top:10px;">
          <button id="clearMeal" class="btn btn-secondary">
            Clear Meal
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Key for localStorage
    const STORAGE_KEY = 'foods';

    // Get elements
    const foodName = document.getElementById('foodName');
    const servingGrams = document.getElementById('servingGrams');
    const carbs = document.getElementById('carbs');
    const protein = document.getElementById('protein');
    const addFoodBtn = document.getElementById('addFoodBtn');
    const foodsTableBody = document.querySelector('#foodsTable tbody');
    const mealTableBody = document.querySelector('#mealTable tbody');
    const totalCarbsEl = document.getElementById('totalCarbs');
    const totalProteinEl = document.getElementById('totalProtein');
    const clearMealBtn = document.getElementById('clearMeal');
    const exportFoodsBtn = document.getElementById('exportFoods');
    const importFoodsBtn = document.getElementById('importFoods');
    const importFileInput = document.getElementById('importFile');
    const clearAllFoodsBtn = document.getElementById('clearAllFoods');
    const searchFood = document.getElementById('searchFood');

    // foods: array of {id,name,servingGrams,carbs,protein}
    // meal: array of {id,name,servingGrams,carbs,protein, consumedGrams}
    let foods = loadFoods();
    let meal = [];

    function saveFoods() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(foods));
    }

    function loadFoods() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        return JSON.parse(raw);
      } catch (e) {
        console.error('Could not parse foods from storage', e);
        return [];
      }
    }

    function renderFoods(filter='') {
      foodsTableBody.innerHTML = '';
      const q = filter.trim().toLowerCase();
      foods.forEach(food => {
        if (q && !food.name.toLowerCase().includes(q)) return;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(food.name)}</td>
          <td>${formatNum(food.servingGrams)}</td>
          <td>${formatNum(food.carbs)}</td>
          <td>${formatNum(food.protein)}</td>
          <td style="white-space:nowrap">
            <button data-id="${food.id}" class="btn btn-primary btn-sm add-to-meal">Add to Meal</button>
            <button data-id="${food.id}" class="btn btn-danger btn-sm delete-food">Delete</button>
          </td>
        `;
        foodsTableBody.appendChild(tr);
      });
    }

    function computeNutrientsForConsumed(servingGramsVal, servingCarbs, servingProtein, consumedGramsVal) {
      const s = Number(servingGramsVal) || 0;
      if (s <= 0) return { carbs: 0, protein: 0 };
      const ratio = Number(consumedGramsVal) / s;
      const c = roundIfNeeded((Number(servingCarbs) || 0) * ratio);
      const p = roundIfNeeded((Number(servingProtein) || 0) * ratio);
      return { carbs: c, protein: p };
    }

    function renderMeal() {
      mealTableBody.innerHTML = '';
      let totalCarbs = 0;
      let totalProtein = 0;
      meal.forEach((f, idx) => {
        // ensure consumedGrams exists
        if (f.consumedGrams === undefined || f.consumedGrams === null) f.consumedGrams = f.servingGrams || 0;
        const nutrients = computeNutrientsForConsumed(f.servingGrams, f.carbs, f.protein, f.consumedGrams);
        totalCarbs += Number(nutrients.carbs) || 0;
        totalProtein += Number(nutrients.protein) || 0;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(f.name)}</td>
          <td>${formatNum(f.servingGrams)}</td>
          <td>
            <input class="meal-grams"
                   data-idx="${idx}"
                   type="number"
                   min="0"
                   step="1"
                   inputmode="numeric"
                   pattern="\\d*"
                   value="${formatNum(Math.round(f.consumedGrams || 0))}" />
          </td>
          <td class="meal-carbs" data-idx="${idx}">${formatNum(nutrients.carbs)}</td>
          <td class="meal-protein" data-idx="${idx}">${formatNum(nutrients.protein)}</td>
          <td style="white-space:nowrap">
            <button data-idx="${idx}" class="btn btn-secondary btn-sm remove-from-meal">Remove</button>
          </td>
        `;
        mealTableBody.appendChild(tr);
      });
      totalCarbsEl.textContent = formatNum(totalCarbs);
      totalProteinEl.textContent = formatNum(totalProtein);
    }

    function addFood() {
      const name = foodName.value.trim();
      const s = parseFloat(servingGrams.value);
      const c = parseFloat(carbs.value);
      const p = parseFloat(protein.value);
      if (!name) { alert('Please enter a name'); return; }
      if (Number.isNaN(s) || Number.isNaN(c) || Number.isNaN(p)) { alert('Please enter numeric values for serving, carbs, and protein'); return; }
      const id = Date.now().toString(36) + Math.random().toString(36).slice(2,6);
      const entry = { id, name, servingGrams: roundIfNeeded(s), carbs: roundIfNeeded(c), protein: roundIfNeeded(p) };
      foods.push(entry);
      saveFoods();
      renderFoods(searchFood.value || '');
      // Clear inputs
      foodName.value = '';
      servingGrams.value = '';
      carbs.value = '';
      protein.value = '';
      foodName.focus();
    }

    function addToMealById(id) {
      const f = foods.find(x => x.id === id);
      if (!f) return;
      // push a shallow copy and default consumedGrams to servingGrams (rounded integer)
      const copy = Object.assign({}, f);
      copy.consumedGrams = Math.round(copy.servingGrams || 0);
      meal.push(copy);
      renderMeal();
    }

    function removeFoodById(id) {
      if (!confirm('Delete this food from saved foods?')) return;
      foods = foods.filter(x => x.id !== id);
      saveFoods();
      renderFoods(searchFood.value || '');
    }

    function removeFromMeal(idx) {
      meal.splice(idx, 1);
      renderMeal();
    }

    function clearMeal() {
      meal = [];
      renderMeal();
    }

    function exportFoods() {
      const dataStr = JSON.stringify(foods, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'foods.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function importFoodsFile(file) {
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const parsed = JSON.parse(e.target.result);
          if (!Array.isArray(parsed)) throw new Error('Invalid format: expected an array');
          const normalized = parsed.map(item => ({
            id: item.id || (Date.now().toString(36) + Math.random().toString(36).slice(2, 6)),
            name: String(item.name || ''),
            servingGrams: roundIfNeeded(Number(item.servingGrams) || 0),
            carbs: roundIfNeeded(Number(item.carbs) || 0),
            protein: roundIfNeeded(Number(item.protein) || 0)
          }));
          const existsKey = it => foods.some(f => f.name === it.name && Number(f.servingGrams) === Number(it.servingGrams));
          normalized.forEach(it => { if (!existsKey(it)) foods.push(it); });
          saveFoods();
          renderFoods(searchFood.value || '');
          alert('Imported foods. Duplicates (same name + serving) were skipped.');
        } catch (err) {
          alert('Failed to import foods: ' + err.message);
        }
      };
      reader.readAsText(file);
    }

    // Utilities
    function formatNum(n) {
      if (n === null || n === undefined || n === '') return '';
      return Number(n) % 1 === 0 ? Number(n).toString() : Number(n).toFixed(2);
    }
    function roundIfNeeded(n) {
      return Math.round((Number(n) + Number.EPSILON) * 100) / 100;
    }
    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);
    }

    // Event bindings
    addFoodBtn.addEventListener('click', addFood);

    document.addEventListener('click', function (e) {
      // Add to meal
      if (e.target.matches('.add-to-meal') || e.target.closest('.add-to-meal')) {
        const btn = e.target.matches('.add-to-meal') ? e.target : e.target.closest('.add-to-meal');
        addToMealById(btn.getAttribute('data-id'));
        return;
      }
      // Delete saved food
      if (e.target.matches('.delete-food') || e.target.closest('.delete-food')) {
        const btn = e.target.matches('.delete-food') ? e.target : e.target.closest('.delete-food');
        removeFoodById(btn.getAttribute('data-id'));
        return;
      }
      // Remove from meal
      if (e.target.matches('.remove-from-meal') || e.target.closest('.remove-from-meal')) {
        const btn = e.target.matches('.remove-from-meal') ? e.target : e.target.closest('.remove-from-meal');
        removeFromMeal(Number(btn.getAttribute('data-idx')));
        return;
      }
    });

    // Update row nutrients and totals in-place while typing
    document.addEventListener('input', function (e) {
      if (!e.target.matches('.meal-grams')) return;
      const input = e.target;
      const idx = Number(input.getAttribute('data-idx'));
      if (!Number.isFinite(idx) || !meal[idx]) return;

      const raw = input.value;
      const parsed = Number(raw);
      const consumed = Number.isFinite(parsed) ? Math.max(0, parsed) : 0;
      meal[idx].consumedGrams = consumed;

      const nutrients = computeNutrientsForConsumed(meal[idx].servingGrams, meal[idx].carbs, meal[idx].protein, consumed);
      const carbsCell = document.querySelector(`.meal-carbs[data-idx="${idx}"]`);
      const proteinCell = document.querySelector(`.meal-protein[data-idx="${idx}"]`);
      if (carbsCell) carbsCell.textContent = formatNum(nutrients.carbs);
      if (proteinCell) proteinCell.textContent = formatNum(nutrients.protein);

      // recompute totals
      let totC = 0, totP = 0;
      document.querySelectorAll('.meal-carbs').forEach(c => totC += parseFloat(c.textContent) || 0);
      document.querySelectorAll('.meal-protein').forEach(p => totP += parseFloat(p.textContent) || 0);
      totalCarbsEl.textContent = formatNum(totC);
      totalProteinEl.textContent = formatNum(totP);
    });

    // Normalize on blur (round consumed to integer)
    document.addEventListener('blur', function (e) {
      if (!e.target.matches('.meal-grams')) return;
      const input = e.target;
      const idx = Number(input.getAttribute('data-idx'));
      if (!Number.isFinite(idx) || !meal[idx]) return;
      const parsed = Number(input.value);
      const rounded = Number.isFinite(parsed) ? Math.max(0, Math.round(parsed)) : 0;
      meal[idx].consumedGrams = rounded;
      input.value = String(rounded);

      const nutrients = computeNutrientsForConsumed(meal[idx].servingGrams, meal[idx].carbs, meal[idx].protein, rounded);
      const carbsCell = document.querySelector(`.meal-carbs[data-idx="${idx}"]`);
      const proteinCell = document.querySelector(`.meal-protein[data-idx="${idx}"]`);
      if (carbsCell) carbsCell.textContent = formatNum(nutrients.carbs);
      if (proteinCell) proteinCell.textContent = formatNum(nutrients.protein);

      let totC = 0, totP = 0;
      document.querySelectorAll('.meal-carbs').forEach(c => totC += parseFloat(c.textContent) || 0);
      document.querySelectorAll('.meal-protein').forEach(p => totP += parseFloat(p.textContent) || 0);
      totalCarbsEl.textContent = formatNum(totC);
      totalProteinEl.textContent = formatNum(totP);
    }, true);

    clearMealBtn.addEventListener('click', function () { if (confirm('Clear current meal?')) clearMeal(); });
    exportFoodsBtn.addEventListener('click', exportFoods);
    importFoodsBtn.addEventListener('click', function () { importFileInput.click(); });
    importFileInput.addEventListener('change', function (e) {
      const f = e.target.files[0];
      if (f) importFoodsFile(f);
      importFileInput.value = '';
    });

    clearAllFoodsBtn.addEventListener('click', function () {
      if (!confirm('Delete ALL saved foods? This cannot be undone.')) return;
      foods = [];
      saveFoods();
      renderFoods();
    });

    searchFood.addEventListener('input', function () { renderFoods(searchFood.value || ''); });

    // Initialize
    renderFoods();
    renderMeal();
  </script>
</body>
</html>